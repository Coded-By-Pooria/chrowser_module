"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("chrome-launcher"),e=require("chrome-remote-interface");function i(t,e,i,s){return new(i||(i=Promise))((function(r,n){function o(t){try{a(s.next(t))}catch(t){n(t)}}function l(t){try{a(s.throw(t))}catch(t){n(t)}}function a(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,l)}a((s=s.apply(t,e||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;class s{constructor(t,e){this.tabId=t,this.tabHelper=e}move(t){return i(this,void 0,void 0,(function*(){this.tabHelper.sessionZone(this.tabId,(e=>i(this,[e],void 0,(function*({Input:e}){yield e.dispatchMouseEvent(Object.assign({type:"mouseMoved"},t))}))))}))}click(t){return i(this,void 0,void 0,(function*(){this.tabHelper.sessionZone(this.tabId,(e=>i(this,[e],void 0,(function*({Input:e}){var i;yield e.dispatchMouseEvent(Object.assign(Object.assign({type:"mousePressed"},t),{clickCount:1})),t.delay&&(yield(i=t.delay,new Promise((t=>{setTimeout((()=>t()),i)})))),yield e.dispatchMouseEvent(Object.assign(Object.assign({type:"mouseReleased"},t),{clickCount:1}))}))))}))}}class r{constructor(t,e){this._tabId=t,this.helper=e}navigate(t){return i(this,void 0,void 0,(function*(){return yield this.helper.navigate(this.tabId,t)}))}evaluate(t){return this.helper.evaluateScriptOnTab(t,this.tabId)}get tabId(){return this._tabId}get mouseHandler(){var t;return null!==(t=this._mouseHandler)&&void 0!==t?t:this._mouseHandler=this.helper.provideMouseHandler(this.tabId)}close(){return this.helper.close(this.tabId)}addScriptToRunOnNewDocument(t){return this.helper.addScriptToRunOnNewDocument(t,this.tabId)}waitUntilNetworkIdle(){return i(this,arguments,void 0,(function*(t={idleInterval:500,idleNumber:0}){return this.helper.waitUntilNetworkIdle(this.tabId,t)}))}}class n{constructor(t,e,i,s=null,r=null,n=void 0,o=null,l=null,a="",u="",d=void 0,h=!1){this._this=t,this.typeName=e,this.func=i,this.functionName=s,this.methodName=r,this.fileName=n,this.lineNumber=o,this.columnNumber=l,this.sourceURL=a,this.scriptHash=u,this.evalOrigion=d,this.isEvalInvokation=h}getThis(){return this._this}getTypeName(){return this.typeName}getFunction(){return this.func}getFunctionName(){return this.functionName}getMethodName(){return this.methodName}getFileName(){return this.fileName}getLineNumber(){return this.lineNumber}getColumnNumber(){return this.columnNumber}getEvalOrigin(){return this.evalOrigion}isToplevel(){return this._this===global}isEval(){return this.isEvalInvokation}isNative(){return!1}isConstructor(){return!1}isAsync(){return!1}isPromiseAll(){return!1}getPromiseIndex(){return-1}getScriptNameOrSourceURL(){return this.sourceURL}getScriptHash(){return this.scriptHash}getEnclosingColumnNumber(){var t;return null!==(t=this.columnNumber)&&void 0!==t?t:-1}getEnclosingLineNumber(){var t;return null!==(t=this.lineNumber)&&void 0!==t?t:-1}getPosition(){return-1}toString(){return`at ${this.functionName} - line ${this.lineNumber} on column ${this.columnNumber}`}}class o extends Error{static mapToCallSite(t){return t.callFrames.map((t=>new n(void 0,"",void 0,t.functionName,null,void 0,t.lineNumber,t.columnNumber,t.url,t.scriptId)))}constructor(t){super(t.text),this.error=t}printEvalStackTrace(){var t;if(!this.error.stackTrace)return;const e=o.mapToCallSite(this.error.stackTrace);return null===(t=Error.prepareStackTrace)||void 0===t?void 0:t.call(Error,this,e)}}class l extends Error{constructor(t){super(t)}}function a(t){let e,i=!1;if("string"==typeof t)e=t.trim(),i=e.startsWith("async");else{const s=t.toString().trim();i=s.startsWith("async"),e=`(${s})()`}return{serialazedFunc:e,shouldAwait:i}}class u{constructor(t,e){this.chromeSessionPort=t,this.onClose=e}provideMouseHandler(t){return new s(t,this)}newTab(t){return i(this,void 0,void 0,(function*(){const i=yield e.New(Object.assign({port:this.chromeSessionPort},t));return new r(i.id,this)}))}sessionZone(t,s){return i(this,void 0,void 0,(function*(){const i=yield e({port:this.chromeSessionPort,target:t});try{return yield s(i)}catch(t){throw t}finally{yield i.close()}}))}navigate(t,e){return i(this,void 0,void 0,(function*(){yield this.sessionZone(t,(t=>i(this,void 0,void 0,(function*(){var i,s;const{Page:r}=t;yield r.enable();const n=yield r.navigate(e);if(null===(i=n.errorText)||void 0===i?void 0:i.trim())throw new l(n.errorText);switch(null!==(s=e.waitUntil)&&void 0!==s?s:"load"){case"documentloaded":yield r.domContentEventFired();break;case"load":yield r.loadEventFired()}}))))}))}addScriptToRunOnNewDocument(t,e){return i(this,void 0,void 0,(function*(){return yield this.sessionZone(e,(e=>i(this,void 0,void 0,(function*(){const{Page:i}=e,{serialazedFunc:s}=a(t);yield i.addScriptToEvaluateOnNewDocument({source:s})}))))}))}evaluateScriptOnTab(t,e,s){return i(this,void 0,void 0,(function*(){return yield this.sessionZone(e,(e=>i(this,void 0,void 0,(function*(){const{Runtime:i}=e,{serialazedFunc:r,shouldAwait:n}=a(t),l=yield i.evaluate({expression:r,awaitPromise:null!=s?s:n,returnByValue:!0});if(l.exceptionDetails)throw new o(l.exceptionDetails);return l.result.value}))))}))}waitUntilNetworkIdle(t,e){return i(this,void 0,void 0,(function*(){return this.sessionZone(t,(({Network:t})=>d.start(t,e)))}))}close(t){return i(this,void 0,void 0,(function*(){var i;yield e.Close({id:t,port:this.chromeSessionPort}),yield null===(i=this.onClose)||void 0===i?void 0:i.call(this,t)}))}}class d{constructor(t,e,i){this.networkContext=t,this.idleInterval=e,this.tolerance=i,this.isResolved=!1}start(){return i(this,void 0,void 0,(function*(){return yield this.networkContext.enable(),this.lastIdleItem=Date.now(),this.networkContext.on("requestWillBeSent",(t=>{this.isResolved||this.resetTimer()})),this.networkContext.on("responseReceived",(t=>{this.isResolved||this.resetTimer()})),this.setTimer(),new Promise(((t,e)=>{this.waiterResolver=t,this.waiterRejecter=e}))}))}resetTimer(){const t=Date.now();t-this.lastIdleItem>=this.idleInterval-this.tolerance*this.idleInterval?this.resolve():(this.lastIdleItem=t,clearTimeout(this.timerId),this.setTimer())}setTimer(){this.timerId=setTimeout((()=>{this.resolve()}),this.idleInterval)}resolve(){return i(this,void 0,void 0,(function*(){this.isResolved=!0,yield this.networkContext.disable(),this.waiterResolver()}))}static start(t,e){var i;const s=null!==(i=e.tolerance)&&void 0!==i?i:.05;return new d(t,e.idleInterval,s).start()}}class h{static create(t){return i(this,void 0,void 0,(function*(){const{Target:i}=yield e({port:t}),s=yield i.getTargetInfo();return new h(t,s.targetInfo.targetId)}))}constructor(t,e){this.chromeSessionPort=t,this.openedTabs=new Map,this.tabHelper=new u(t,this.close.bind(this)),this.openedTabs.set(e,new r(e,this.tabHelper))}newTab(){return i(this,arguments,void 0,(function*(t={url:""}){const e=yield this.tabHelper.newTab(t);return this.openedTabs.set(e.tabId,e),e}))}getAllTabs(){return[...this.openedTabs.values()]}close(t){return i(this,void 0,void 0,(function*(){this.openedTabs.delete(t)}))}}class c{static create(t){return i(this,void 0,void 0,(function*(){const e=new c(t);return yield e.init(),e}))}constructor(t){this.browserOptions=t,this.isClosed=!1,this.defaultTabConsumed=!1}init(){return i(this,void 0,void 0,(function*(){var e,i,s,r;const n=[];(null===(i=null===(e=this.browserOptions)||void 0===e?void 0:e.userDir)||void 0===i?void 0:i.trim())&&n.push(`--user-data-directory="${this.browserOptions.userDir.trim()}"`),(null===(r=null===(s=this.browserOptions)||void 0===s?void 0:s.args)||void 0===r?void 0:r.length)&&n.push(...this.browserOptions.args),this.window=yield t.launch({chromeFlags:n}),this.tabHandler=yield h.create(this.window.port)}))}newTab(){return i(this,arguments,void 0,(function*(t={url:""}){return this.isCloseCheck(),this.defaultTabConsumed?this.tabHandler.newTab(t):(this.defaultTabConsumed=!0,this.tabHandler.getAllTabs()[0])}))}close(){this.isClosed=!0,this.window.kill()}isCloseCheck(){if(this.isClosed)throw new Error("Cannot operate on closed browser. Launch another instance of chrowser and try this action.")}getAllOpenTabs(){return this.isCloseCheck(),this.tabHandler.getAllTabs()}}exports.Tab=r,exports.default=c;
